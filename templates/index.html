<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YIELD Recommendation Engine</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        input[type="text"] {
            width: 60%;
            padding: 8px;
        }
        button {
            padding: 8px 16px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #cccccc;
            padding: 6px;
            text-align: left;
        }
        h2 {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h1>YIELD ML Engine</h1>
    <p>Enter your request text to get labour and equipment recommendations.</p>

    <form id="queryForm">
        <input type="text" id="queryInput" placeholder="e.g. need harvester for paddy in Yala season" required>
        <button type="submit">Search</button>
    </form>

    <div id="messages"></div>

    <div id="results" style="display:none;">
        <h2>Predictions</h2>
        <p id="predictedLabour"></p>
        <p id="predictedEquipment"></p>

        <h2>Labour Recommendations</h2>
        <table id="labourTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Labour Type</th>
                    <th>Season</th>
                    <th>Crop Type</th>
                    <th>Hourly Rate</th>
                    <th>Rating</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Equipment Recommendations</h2>
        <table id="equipTable">
            <thead>
                <tr>
                    <th>Equipment Type</th>
                    <th>For Crop</th>
                    <th>Season</th>
                    <th>Nearest District</th>
                    <th>Condition</th>
                    <th>Hourly Rate (LKR)</th>
                    <th>Rating</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const form = document.getElementById('queryForm');
        const input = document.getElementById('queryInput');
        const resultsDiv = document.getElementById('results');
        const messagesDiv = document.getElementById('messages');

        const predictedLabourP = document.getElementById('predictedLabour');
        const predictedEquipmentP = document.getElementById('predictedEquipment');

        const labourTableBody = document.querySelector('#labourTable tbody');
        const equipTableBody   = document.querySelector('#equipTable tbody');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = input.value.trim();
            if (!query) return;

            messagesDiv.textContent = "Loading...";
            resultsDiv.style.display = "none";
            labourTableBody.innerHTML = "";
            equipTableBody.innerHTML = "";

            try {
                const res = await fetch('/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, top_k: 5 })
                });

                const data = await res.json();

                if (!res.ok) {
                    messagesDiv.textContent = data.error || "Error from server.";
                    return;
                }

                messagesDiv.textContent = "";
                resultsDiv.style.display = "block";

                predictedLabourP.textContent = "Predicted Labour Type: " + data.predicted_labour_type;
                predictedEquipmentP.textContent = "Predicted Equipment Type: " + data.predicted_equipment_type;

                // ---------------- Labour rows ----------------
                labourTableBody.innerHTML = "";
                if (data.labour_recommendations && data.labour_recommendations.length > 0) {
                    data.labour_recommendations.forEach(rec => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${rec.Name || ''}</td>
                            <td>${rec.Location || ''}</td>
                            <td>${rec.Labour_Type || ''}</td>
                            <td>${rec.Season || ''}</td>
                            <td>${rec.Crop_Type || ''}</td>
                            <td>${rec.Hourly_Rate !== undefined ? rec.Hourly_Rate : ''}</td>
                            <td>${rec.Rating !== undefined ? rec.Rating : ''}</td>
                            <td>${rec.score !== undefined ? rec.score.toFixed(3) : ''}</td>
                        `;
                        labourTableBody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="8">No labour matches found.</td>`;
                    labourTableBody.appendChild(tr);
                }

                // ---------------- Equipment rows ----------------
                equipTableBody.innerHTML = "";
                const hasEquipmentFlag = (typeof data.has_equipment_matches !== "undefined")
                    ? data.has_equipment_matches
                    : true; // default true if old backend

                if (!hasEquipmentFlag || !data.equipment_recommendations || data.equipment_recommendations.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="8">No equipment matches found.</td>`;
                    equipTableBody.appendChild(tr);
                } else {
                    data.equipment_recommendations.forEach(rec => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${rec.Equipment_Type || ''}</td>
                            <td>${rec.For_Crop || ''}</td>
                            <td>${rec.Season || ''}</td>
                            <td>${rec.Nearest_Major_District || ''}</td>
                            <td>${rec.Condition || ''}</td>
                            <td>${rec.Hourly_Rate_LKR !== undefined ? rec.Hourly_Rate_LKR : ''}</td>
                            <td>${rec.Rating !== undefined ? rec.Rating : ''}</td>
                            <td>${rec.score !== undefined ? rec.score.toFixed(3) : ''}</td>
                        `;
                        equipTableBody.appendChild(tr);
                    });
                }

            } catch (err) {
                console.error(err);
                messagesDiv.textContent = "Error fetching results. Check server and try again.";
            }
        });
    </script>
</body>
</html>
